{% extends 'layouts/base.html' %}

{% set page_title = 'Home' %}

{% block container %}
    <div class="container">

        <div class="blog-header"><h3 class="blog-title">Home</h3></div>


        <div class="panel panel-default">
            <!-- Default panel contents -->
            <div class="panel-heading">Last 25 runs</div>
            <div class="panel-body">
                <p class="text-center">
                    <div id="placeholder" class="text-center" style="width:800px;height:200px;">
                        <h3>Loading run statistics</h3>
                     </div>
                    <span id="hoverdata"></span>
		            <span id="clickdata"></span>
                </p>
            </div>


            <!-- Table -->
            <table class="table">
                <tr>
                    <th>Number</th>
                    <th>Date</th>
                    <th>Events</th>
                </tr>
                {% for run in runs %}
                    <tr>
                        <td><a class="btn btn-default btn-sm"
                               href="{{ url_for('runs.info', run_number=run.number) }}">{{ run.number }}</a></td>
                        <td>{{ run.start_time }}</td>
                        <th>{{ run.total_events }}</th>
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>
{% endblock %}

{% block js_btm %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/jquery.flot.min.js') }}"></script>

    <script type="text/javascript">
        $(function () {

            var points = [];
            var ticks = [];
            var runs = [];

            {% for run in runs %}
                points.push([{{ loop.revindex0 }}, {{ run.total_events }}]);
                ticks.push([{{ loop.revindex0 }}, {{ run.number }}]);
                runs.push({"number":"{{ run.number }}", "total_events":"{{ run.total_events }}", "start_time":"{{ run.start_time }}" })
            {% endfor %}

            points.reverse()
            ticks.reverse()
            runs.reverse()

            var plot = $.plot("#placeholder", [
                { data: points, label: "Events(Run)"}
            ], {
                series: {
                    lines: {
                        show: true
                    },
                    points: {
                        show: true
                    }
                },
                grid: {
                    hoverable: true,
                    clickable: true
                },
                xaxis: {
                    ticks: ticks
                }
            });

            $("<div id='tooltip'></div>").css({
                position: "absolute",
                display: "none",
                border: "1px solid #fdd",
                padding: "2px",
                "background-color": "#fee",
                opacity: 0.80
            }).appendTo("body");

            $("#placeholder").bind("plothover", function (event, pos, item) {

                if ($("#enablePosition:checked").length > 0) {
                    var str = "(" + pos.x.toFixed(2) + ", " + pos.y.toFixed(2) + ")";
                    $("#hoverdata").text(str);
                }


                if (item) {
                    //var x = item.datapoint[0].toFixed(2);
                    //var y = item.datapoint[1].toFixed(2);
                    var index = item.datapoint[0].toFixed(0);
                    var run = runs[index];

                    $("#tooltip").html("Run: " + run.number+ "<br>Events: " + run.total_events + "<br>Started: " + run.start_time)
                            .css({top: item.pageY + 5, left: item.pageX + 5})
                            .fadeIn(200);
                } else {
                    $("#tooltip").hide();
                }

            });

            $("#placeholder").bind("plotclick", function (event, pos, item) {
                if (item) {
                    $("#clickdata").text(" - click point " + item.dataIndex + " in " + item.series.label);
                    plot.highlight(item.series, item.datapoint);
                }
            });

            // Add the Flot version string to the footer

            $("#footer").prepend("Flot " + $.plot.version + " &ndash; ");
        });
    </script>

{% endblock %}